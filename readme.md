# セッション攻撃テスト

このリポジトリには簡易的な Node.js サーバーと、Web セッションの挙動をログ取得するユーティリティが含まれています。`resource/abnormal_logger.js` を利用することで、認証なしアクセスやトークン再利用など 10 種類の異常パターン (A1–A10) を実演できます。

## 使い方

まず Node の依存モジュールをインストールします。

```bash
npm install
```

次に npm 経由でテストを実行します。

```bash
npm test
```

このコマンドではサーバを起動し、正常ログと異常ログを取得します。生成されたログは `resource/logs/normal_log.csv` と `resource/logs/abnormal_log.csv` に保存されます。IPアドレスはプライバシー保護のため記録されません。

### 正常ログの取得

手動で正常系列だけを記録したい場合は、`resource/normal_logger.js` を実行します。以下のプロンプトを参考にしてください。

```bash
node resource/normal_logger.js --n 50 --d 100 --p 4
```

上記では 50 本の正常操作系列を 100ms 間隔で開始し、最大4並列で実行します。各操作間にはエンドポイントに応じた人間らしい遅延(ログイン後は0.5〜1.5秒、ページ閲覧後は数秒〜数分など)が挿入され、結果は `resource/logs/normal_log.csv` に追記されます。

### 異常ログの取得

異常操作系列を生成するには `resource/abnormal_logger.js` を使用します。

```bash
node resource/abnormal_logger.js --n 50 --d 100 --p 4
```
こちらは 50 本のランダムな異常シナリオを最大4並列で実行し、`resource/logs/abnormal_log.csv` に保存します。各操作も人間的な遅延を挟みます。

### シナリオ

典型的な Web サービスの正常／異常フローを `src/scenarios/` 以下に用意しています。正常シナリオではショッピングやフォーラム利用を模擬し、異常シナリオでは認証抜けや順序違反などの動作を記述しています。これらの JSON ファイルをキャプチャ用ルートから実行することで、モデル学習用の操作ログを追加生成できます。現在は30以上のシナリオを収録しており、EC購入やカート操作、掲示板投稿、エラーケース、ストレスパターンを網羅しています。最新バージョンでは `/profile` と `/search` エンドポイントが追加され、正常シナリオではそれらを訪問する流れが含まれ、異常シナリオでは未認証アクセスや順序違反のプロフィール更新をテストします。


### 各スクリプトのオプション

主要な実行ファイルと設定ファイルの引数および既定値を以下にまとめます。

| ファイル | オプション | 既定値 | 説明 |
| --- | --- | --- | --- |
| resource/normal_logger.js | `--n` | `100` | 生成する正常系列数 |
|  | `--d` | `100` | 各系列間の待ち時間(ms) |
|  | `--p` | `1` | 同時実行数 |
| resource/abnormal_logger.js | `--n` | `100` | 生成する異常系列数 |
|  | `--d` | `100` | 各系列間の待ち時間(ms) |
|  | `--p` | `1` | 同時実行数 |
| test.js | `--n` | `100` | 正常系列数 |
|  | `--d` | `100` | 正常 delay(ms) |
|  | `--an` | `100` | 異常系列数 |
|  | `--ad` | `100` | 異常 delay(ms) |


### MATLAB 用前処理

取得したCSVログは `resource/preprocess_log_to_mat.py` で MATLAB 向けの `.mat` ファイルへ変換できます。

```bash
python resource/preprocess_log_to_mat.py resource/logs/normal_log.csv
```

`-o` オプションで出力ファイル名を指定可能です。ログをセッション単位の数値系列へ整形し、エンドポイントとメソッドのカテゴリ情報を含めて保存します。
